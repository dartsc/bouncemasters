<!DOCTYPE html>
<html>

<head>

    <title>Game</title>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-touch-fullscreen" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="msapplication-tap-highlight" content="no"/>
    <meta name="MobileOptimized" content="960"/>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no, minimal-ui"/>
    <meta charset="utf-8"/>

    <link rel="stylesheet" type="text/css" href="style/index.css" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"/>

        <script src="https://www.youtube.com/game_api/v1" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
    <!-- Google Identity Services (loaded dynamically below when a client ID is provided) -->
    <script nonce="fXbPLqjXr3k5ALRtf-ZFZQ">window.GOOGLE_CLIENT_ID = '467225574317-ftdf9qf93ih9on6a1p4pa97667mr7ekf.apps.googleusercontent.com';</script>
        <!-- Firebase (compat) for easy integration; fill FIREBASE_CONFIG below -->
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
        <script nonce="fXbPLqjXr3k5ALRtf-ZFZQ">

        </script>
    <!-- Progress persistence shim: mirrors platform storage to localStorage for reliable saves locally -->
    <script src="scripts/progress_persist.js" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
    <!-- Google Sign-In integration (uses GOOGLE_CLIENT_ID if provided) -->
    <script src="scripts/google_signin.js" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
<script src="game.js" nonce="fXbPLqjXr3k5ALRtf-ZFZQ"></script>
<script nonce="fXbPLqjXr3k5ALRtf-ZFZQ">window.addEventListener("load", () => {
    try { window.runGame && window.runGame(); } catch(_) {}

    // Simple, robust audio unlock routine (no external files)
    (function(){
        if (window.__audioUnlockInstalled) return; window.__audioUnlockInstalled = true;
        let unlocked = !!window.__audioUnlocked;
        let createdCtx = null;

        function resume(p){ try{ if (p && typeof p.then==='function') return p.catch(()=>{});}catch(_){} return Promise.resolve(); }
        function resumeKnownLibs(){
            const tasks = [];
            try { if (window.Howler && Howler.ctx && Howler.ctx.resume) tasks.push(resume(Howler.ctx.resume())); if (window.Howler && typeof Howler.mute==='function') Howler.mute(false); } catch(_){}
            try { const ps = window.PIXI && window.PIXI.sound; const pctx = ps && (ps.context && (ps.context.audioContext||ps.context)); if (pctx && pctx.resume) tasks.push(resume(pctx.resume())); if (ps && typeof ps.unmute==='function') ps.unmute(); } catch(_){}
            try { const g = window.game || window.__phaserGame || (window.Phaser && window.Phaser.GAMES && window.Phaser.GAMES[0]); const snd = g && g.sound; const actx = (snd && snd.context) || (g && g.sys && g.sys.game && g.sys.game.audioContext); if (actx && actx.resume) tasks.push(resume(actx.resume())); if (snd && typeof snd.unlock==='function') snd.unlock(); } catch(_){}
            try { const any = window.__globalAudioCtx || window.__audioCtx || window.audioContext; if (any && any.resume) tasks.push(resume(any.resume())); } catch(_){}
            return Promise.all(tasks).then(()=>{});
        }
        function playSilentWebAudio(){
            try {
                const AC = window.AudioContext || window.webkitAudioContext; if (!AC) return Promise.resolve(false);
                createdCtx = createdCtx || new AC(); window.__globalAudioCtx = createdCtx; const ctx = createdCtx;
                if (ctx.state === 'suspended' && ctx.resume) return ctx.resume().then(()=>true,()=>false);
                const buf = ctx.createBuffer(1,1,22050); const src = ctx.createBufferSource(); src.buffer = buf; src.connect(ctx.destination); try{src.start(0);}catch(_){/*noop*/}
                if (ctx.state === 'suspended' && ctx.resume) return ctx.resume().then(()=>true,()=>false);
                return Promise.resolve(true);
            } catch(_) { return Promise.resolve(false); }
        }
        function playSilentHtmlAudio(){
            try {
                const SILENT = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA/////wAAAAC4AU9wZW5Tb3VuZAAAAAAA';
                const a = new Audio(); a.src = SILENT; a.loop = false; a.volume = 0.01; const p = a.play();
                if (p && typeof p.then==='function') return p.then(()=>{try{a.pause();}catch(_){ } return true;}, ()=>false);
                return Promise.resolve(true);
            } catch(_) { return Promise.resolve(false); }
        }
        function markUnlocked(){ if (unlocked) return; unlocked = true; try{window.__audioUnlocked = true;}catch(_){} try{window.dispatchEvent(new Event('audio:unlocked'));}catch(_){} }
        function ensure(){ if (unlocked) return Promise.resolve(true); return resumeKnownLibs().then(playSilentWebAudio).then(()=>playSilentHtmlAudio()).then(()=>{ markUnlocked(); return true; }).catch(()=>unlocked); }

        // Overlay shown only until first gesture
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);color:#fff;font:600 16px system-ui,Segoe UI,Arial;z-index:9999;user-select:none;';
        overlay.innerHTML = '<div style="text-align:center;padding:14px 20px;background:rgba(0,0,0,.35);border-radius:12px;backdrop-filter:blur(2px)">Tap to enable sound<br><span style="opacity:.85;font-weight:500;font-size:13px">We\'ll remember</span></div>';
        function unlockAndClose(){ ensure(); try{ overlay.remove(); }catch(_){} cleanup(); }
        function cleanup(){ window.removeEventListener('pointerdown', unlockAndClose, true); window.removeEventListener('keydown', unlockAndClose, true); }

        try {
            if (!unlocked) {
                document.body.appendChild(overlay);
                window.addEventListener('pointerdown', unlockAndClose, { once:true, capture:true });
                window.addEventListener('keydown', unlockAndClose, { once:true, capture:true });
                window.addEventListener('audio:unlocked', () => { try{ overlay.remove(); }catch(_){} cleanup(); }, { once:true });
            }
        } catch(_) {}
    })();
});</script>
</head>

<body>
        <div id="game"></div>
        <div id="auth" style="position:fixed;top:10px;right:10px;z-index:9999;display:flex;gap:8px;align-items:center;">
            <div id="gsi_button"></div>
            <div id="user_info" style="display:none;gap:6px;align-items:center;font:500 12px system-ui,Segoe UI,Arial;color:#fff;background:rgba(0,0,0,0.4);padding:4px 8px;border-radius:12px;">
                <img id="user_pic" src="" alt="" style="width:18px;height:18px;border-radius:50%;object-fit:cover;"/>
                <span id="user_name"></span>
                <button id="signout_btn" style="margin-left:6px;padding:2px 6px;font:600 11px system-ui;cursor:pointer;">Sign out</button>
            </div>
        </div>
</body>
</html>